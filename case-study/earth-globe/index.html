<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>模仿 GitHub 首页的地球 🌍 | 守得云开不见月</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">模仿 GitHub 首页的地球 🌍</h1><a id="logo" href="/.">守得云开不见月</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">模仿 GitHub 首页的地球 🌍</h1><div class="post-meta">2021-07-01<span> | </span><span class="category"><a href="/categories/Case-Study/">Case Study</a></span></div><a class="disqus-comment-count" data-disqus-identifier="case-study/earth-globe/" href="/case-study/earth-globe/#disqus_thread"></a><div class="post-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>参与了一个反爬的项目，主要做的事情就是识别请求中的爬虫们，前端则需要一个数据可视化的看板。由于爬虫总是通过一些奇怪的代理打来，所以ip源分布于世界各地。<br>为了可以让看板酷一些，决定模仿 <a href="https://github.com/" target="_blank" rel="noopener">GitHub 首页</a>(退出登录才能看到) 那个地球做一个类似的效果。</p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><div class="video-container"><iframe src="https://www.youtube.com/embed/TVsl5djHoVA" frameborder="0" loading="lazy" allowfullscreen></iframe></div>
<h5 id="此处应有-YouTube-视频-需要🪜"><a href="#此处应有-YouTube-视频-需要🪜" class="headerlink" title="此处应有 YouTube 视频 需要🪜"></a>此处应有 YouTube 视频 需要🪜</h5><img src="/images/case-study/earth/earth-5.png" alt="最终效果" />

<h2 id="用到的工具"><a href="#用到的工具" class="headerlink" title="用到的工具"></a>用到的工具</h2><p><a href="https://threejs.org" target="_blank" rel="noopener">three.js</a>、<a href="https://github.com/tweenjs/tween.js" target="_blank" rel="noopener">tween.js</a> 、<a href="https://www.typescriptlang.org/" target="_blank" rel="noopener">TypeScript</a></p>
<h2 id="🌍"><a href="#🌍" class="headerlink" title="🌍"></a>🌍</h2><p>其实简化一下地球本地，就是一个球体，带了世界地图的素材表面、一些发光的效果、鼠标点击转动、自动旋转。</p>
<h3 id="1-绘制一个球体"><a href="#1-绘制一个球体" class="headerlink" title="1. 绘制一个球体"></a>1. 绘制一个球体</h3><p>Earth 是一个独立的类，在它的构建函数里传入尺寸（半径）。</p>
<p>Earth.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Earth</span> </span>&#123;</span><br><span class="line">  private earth: THREE.Mesh</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> (radius: number) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 地球本体</span></span><br><span class="line">    <span class="keyword">const</span> earthGeometry = <span class="keyword">new</span> THREE.SphereGeometry(radius, <span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">    <span class="comment">// 材质</span></span><br><span class="line">    <span class="keyword">const</span> meshBasic = <span class="keyword">new</span> THREE.MeshLambertMaterial(&#123; <span class="attr">color</span>: EARTH_COLOR &#125;)</span><br><span class="line">    <span class="keyword">this</span>.earth = <span class="keyword">new</span> THREE.Mesh(earthGeometry, meshBasic)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里在 Class 内部保存了一个网格对象（<a href="https://threejs.org/docs/#api/zh/objects/Mesh" target="_blank" rel="noopener">THREE.Mesh</a>）</li>
<li>用的是 <a href="https://threejs.org/docs/?q=Material#api/zh/materials/MeshLambertMaterial" target="_blank" rel="noopener">Lambert 网格材质 (MeshLambertMaterial)</a>，可以让地球在光源下更有质感一些。</li>
</ul>
<p>App.ts （入口主文件）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基础的舞台 Class</span></span><br><span class="line"><span class="comment">// 配置灯光、渲染方式、鼠标操控、自动旋转等等...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (parentDom: HTMLElement, size: number) &#123;</span><br><span class="line">    <span class="comment">// 长宽</span></span><br><span class="line">    <span class="keyword">this</span>.containerWidth = size * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">this</span>.containerHeight = size</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wrapper</span></span><br><span class="line">    <span class="keyword">const</span> container = <span class="built_in">document</span>.createElement(<span class="string">'DIV'</span>)</span><br><span class="line">    container.classList.add(<span class="string">'the-earth-wrapper'</span>)</span><br><span class="line">    container.style.width = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.containerWidth&#125;</span>px`</span></span><br><span class="line">    container.style.height = <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.containerHeight&#125;</span>px`</span></span><br><span class="line">    <span class="keyword">const</span> mask = <span class="built_in">document</span>.createElement(<span class="string">'DIV'</span>)</span><br><span class="line">    mask.classList.add(<span class="string">'the-earth-wrapper-mask'</span>)</span><br><span class="line">    mask.style.backgroundImage = <span class="string">`url(<span class="subst">$&#123;flow&#125;</span>)`</span></span><br><span class="line">    container.appendChild(mask)</span><br><span class="line">    parentDom.appendChild(container)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 舞台、相机</span></span><br><span class="line">    <span class="keyword">this</span>.scene = <span class="keyword">new</span> Scene()</span><br><span class="line">    <span class="keyword">this</span>.camera = <span class="keyword">new</span> PerspectiveCamera(<span class="number">65</span>, <span class="keyword">this</span>.containerWidth / <span class="keyword">this</span>.containerHeight, <span class="number">1</span>, <span class="number">1500</span>)</span><br><span class="line">    <span class="comment">// 相机位置，右手坐标系，x,y,z</span></span><br><span class="line">    <span class="keyword">this</span>.camera.position.set(<span class="number">-150</span>, <span class="number">100</span>, <span class="number">-200</span>)</span><br><span class="line">    <span class="keyword">this</span>.camera.lookAt(<span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="comment">// 渲染器</span></span><br><span class="line">    <span class="keyword">this</span>.renderer = <span class="keyword">new</span> WebGLRenderer(&#123; <span class="attr">antialias</span>: <span class="literal">false</span>, <span class="attr">alpha</span>: <span class="literal">true</span> &#125;) <span class="comment">// 抗锯齿</span></span><br><span class="line">    <span class="keyword">this</span>.renderer.setClearColor(<span class="number">0xffffff</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">this</span>.renderer.autoClear = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>.renderer.setSize(<span class="keyword">this</span>.containerWidth, <span class="keyword">this</span>.containerHeight)</span><br><span class="line">    <span class="keyword">this</span>.renderer.toneMappingExposure = <span class="built_in">Math</span>.pow(<span class="number">1</span>, <span class="number">4.0</span>)</span><br><span class="line">    container.appendChild(<span class="keyword">this</span>.renderer.domElement)</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, () =&gt; <span class="keyword">this</span>.handleWindowResize())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 光源</span></span><br><span class="line">    <span class="keyword">const</span> spotLight = <span class="keyword">new</span> SpotLight(<span class="number">0x404040</span>, <span class="number">2.5</span>)</span><br><span class="line">    spotLight.target = earth</span><br><span class="line">    <span class="keyword">this</span>.scene.add(spotLight)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> light = <span class="keyword">new</span> AmbientLight(<span class="number">0xffffff</span>, <span class="number">0.25</span>) <span class="comment">// soft white light</span></span><br><span class="line">    <span class="keyword">this</span>.scene.add(light)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 地球</span></span><br><span class="line">    <span class="keyword">const</span> theEarth = <span class="keyword">new</span> Earth(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">const</span> earth = theEarth.getMesh()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.earthGroup = <span class="keyword">new</span> Group()</span><br><span class="line">    <span class="keyword">this</span>.earthGroup.add(earth)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scene.add(<span class="keyword">this</span>.earthGroup)</span><br><span class="line">    <span class="keyword">this</span>.render()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前大概是这个样子：<br><img src="/images/case-study/earth/earth-1.png" alt="地球元素" /></p>
<h3 id="2-绘制世界地图"><a href="#2-绘制世界地图" class="headerlink" title="2. 绘制世界地图"></a>2. 绘制世界地图</h3><p>这里需要借助一下两个图片素材：</p>
<ul>
<li>完整的世界地图.png</li>
<li>圆点.png</li>
</ul>
<img src="/images/case-study/earth/earth-2.png" alt="用作球形外面材质的世界地图" />
<img src="/images/case-study/earth/dot.png" alt="用圆点来绘制以上图形" width="30px" style="margin:10px auto 0;" />

<p>Earth.ts 中添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Earth</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (radius: number) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.earthParticles = <span class="keyword">new</span> THREE.Object3D()</span><br><span class="line">    <span class="comment">// 地球表面的点点</span></span><br><span class="line">    <span class="keyword">this</span>.earthImg = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>)</span><br><span class="line">    <span class="keyword">this</span>.earthImg.src = earthBg</span><br><span class="line">    <span class="keyword">this</span>.earthImg.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> earthCanvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>)</span><br><span class="line">      <span class="keyword">const</span> earthCtx = earthCanvas.getContext(<span class="string">'2d'</span>)</span><br><span class="line">      earthCanvas.width = <span class="keyword">this</span>.earthImg.width</span><br><span class="line">      earthCanvas.height = <span class="keyword">this</span>.earthImg.height</span><br><span class="line">      earthCtx?.drawImage(<span class="keyword">this</span>.earthImg, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.earthImg.width, <span class="keyword">this</span>.earthImg.height)</span><br><span class="line">      <span class="keyword">this</span>.earthImgData = earthCtx?.getImageData(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.earthImg.width, <span class="keyword">this</span>.earthImg.height)</span><br><span class="line">      <span class="keyword">this</span>.createEarthParticles()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 简单来说就是读取世界地图后，</span></span><br><span class="line">  <span class="comment">// 把有像素的地方换成圆点的图形来填充，</span></span><br><span class="line">  <span class="comment">// 并上色</span></span><br><span class="line">  private createEarthParticles () &#123;</span><br><span class="line">    <span class="keyword">const</span> positions: any = []</span><br><span class="line">    <span class="keyword">const</span> sizes: any = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">      positions[i] = &#123;</span><br><span class="line">        positions: []</span><br><span class="line">      &#125;</span><br><span class="line">      sizes[i] = &#123;</span><br><span class="line">        sizes: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> THREE.PointsMaterial()</span><br><span class="line">    material.size = <span class="number">2.5</span></span><br><span class="line">    material.color = <span class="keyword">new</span> THREE.Color(EARTH_PARTICLE_COLOR)</span><br><span class="line">    material.map = <span class="keyword">new</span> THREE.TextureLoader().load(dotImg)</span><br><span class="line">    material.depthWrite = <span class="literal">false</span></span><br><span class="line">    material.transparent = <span class="literal">true</span></span><br><span class="line">    material.opacity = <span class="number">0.3</span></span><br><span class="line">    material.side = THREE.FrontSide</span><br><span class="line">    material.blending = THREE.AdditiveBlending</span><br><span class="line">    <span class="keyword">const</span> spherical = <span class="keyword">new</span> THREE.Spherical()</span><br><span class="line">    spherical.radius = <span class="number">100</span></span><br><span class="line">    <span class="keyword">const</span> step = <span class="number">250</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; step; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> vec = <span class="keyword">new</span> THREE.Vector3()</span><br><span class="line">      <span class="keyword">const</span> radians = step * (<span class="number">1</span> - <span class="built_in">Math</span>.sin(i / step * <span class="built_in">Math</span>.PI)) / step + <span class="number">0.5</span> <span class="comment">// 每个纬线圈内的角度均分</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; step; j += radians) &#123;</span><br><span class="line">        <span class="keyword">const</span> c = j / step <span class="comment">// 底图上的横向百分比</span></span><br><span class="line">        <span class="keyword">const</span> f = i / step <span class="comment">// 底图上的纵向百分比</span></span><br><span class="line">        <span class="keyword">const</span> index = <span class="built_in">Math</span>.floor(<span class="number">2</span> * <span class="built_in">Math</span>.random())</span><br><span class="line">        <span class="keyword">const</span> pos = positions[index]</span><br><span class="line">        <span class="keyword">const</span> size = sizes[index]</span><br><span class="line">        <span class="keyword">if</span> (isLandByUV(c, f, &#123; <span class="attr">earthImgData</span>: <span class="keyword">this</span>.earthImgData, <span class="attr">width</span>: <span class="keyword">this</span>.earthImg.width, <span class="attr">height</span>: <span class="keyword">this</span>.earthImg.height &#125;)) &#123; <span class="comment">// 根据横纵百分比判断在底图中的像素值</span></span><br><span class="line">          spherical.theta = c * <span class="built_in">Math</span>.PI * <span class="number">2</span> - <span class="built_in">Math</span>.PI / <span class="number">2</span> <span class="comment">// 横纵百分比转换为theta和phi夹角</span></span><br><span class="line">          spherical.phi = f * <span class="built_in">Math</span>.PI <span class="comment">// 横纵百分比转换为theta和phi夹角</span></span><br><span class="line">          vec.setFromSpherical(spherical) <span class="comment">// 夹角转换为世界坐标</span></span><br><span class="line">          pos.positions.push(vec.x)</span><br><span class="line">          pos.positions.push(vec.y)</span><br><span class="line">          pos.positions.push(vec.z)</span><br><span class="line">          <span class="keyword">if</span> (j % <span class="number">3</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            size.sizes.push(<span class="number">6.0</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; positions.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> pos = positions[i]</span><br><span class="line">      <span class="keyword">const</span> size = sizes[i]</span><br><span class="line">      <span class="keyword">const</span> bufferGeom = <span class="keyword">new</span> THREE.BufferGeometry()</span><br><span class="line">      <span class="keyword">const</span> typedArr1 = <span class="keyword">new</span> <span class="built_in">Float32Array</span>(pos.positions.length)</span><br><span class="line">      <span class="keyword">const</span> typedArr2 = <span class="keyword">new</span> <span class="built_in">Float32Array</span>(size.sizes.length)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; pos.positions.length; j++) &#123;</span><br><span class="line">        typedArr1[j] = pos.positions[j]</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; size.sizes.length; j++) &#123;</span><br><span class="line">        typedArr2[j] = size.sizes[j]</span><br><span class="line">      &#125;</span><br><span class="line">      bufferGeom.setAttribute(<span class="string">'position'</span>, <span class="keyword">new</span> THREE.BufferAttribute(typedArr1, <span class="number">3</span>))</span><br><span class="line">      bufferGeom.setAttribute(<span class="string">'size'</span>, <span class="keyword">new</span> THREE.BufferAttribute(typedArr2, <span class="number">1</span>))</span><br><span class="line">      bufferGeom.computeBoundingSphere()</span><br><span class="line">      <span class="keyword">const</span> particle = <span class="keyword">new</span> THREE.Points(bufferGeom, material)</span><br><span class="line">      <span class="keyword">this</span>.earthParticles.add(particle)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果：<br><img src="/images/case-study/earth/earth-3.png" alt="绘制世界地图" /></p>
<h3 id="3-加入鼠标控制，拖动可以旋转地球"><a href="#3-加入鼠标控制，拖动可以旋转地球" class="headerlink" title="3. 加入鼠标控制，拖动可以旋转地球"></a>3. 加入鼠标控制，拖动可以旋转地球</h3><p>App.ts 中添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">  private controls: OrbitControls</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constructor</span> (parentDom: HTMLElement, size: number) &#123;</span><br><span class="line">  <span class="comment">// 轨迹，鼠标控制</span></span><br><span class="line">  <span class="keyword">this</span>.controls = <span class="keyword">new</span> OrbitControls(<span class="keyword">this</span>.camera, <span class="keyword">this</span>.renderer.domElement)</span><br><span class="line">  <span class="keyword">this</span>.controls.enableZoom = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">this</span>.controls.minDistance = <span class="number">320</span></span><br><span class="line">  <span class="keyword">this</span>.controls.maxDistance = <span class="number">320</span></span><br><span class="line">  <span class="keyword">this</span>.controls.maxPolarAngle = <span class="number">1.5</span></span><br><span class="line">  <span class="keyword">this</span>.controls.minPolarAngle = <span class="number">1</span></span><br><span class="line">  <span class="keyword">this</span>.controls.enablePan = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">this</span>.controls.enableDamping = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">this</span>.controls.dampingFactor = <span class="number">0.05</span></span><br><span class="line">  <span class="keyword">this</span>.controls.rotateSpeed = <span class="number">0.5</span></span><br><span class="line">  <span class="keyword">this</span>.controls.addEventListener(<span class="string">'change'</span>, () =&gt; &#123;</span><br><span class="line">    spotLight.position.copy(<span class="keyword">this</span>.camera.position)</span><br><span class="line">    earthGlow.lookAt(<span class="keyword">new</span> Vector3(<span class="keyword">this</span>.camera.position.x - <span class="number">25</span>, <span class="keyword">this</span>.camera.position.y - <span class="number">50</span>, <span class="keyword">this</span>.camera.position.z + <span class="number">20</span>))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// render 中添加 this.controls.update() 才会生效，并让旋转变得很丝滑</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">this</span>.controls.update()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这是让地球进行自动旋转</span></span><br><span class="line">  <span class="keyword">this</span>.earthGroup.rotation.y += <span class="number">0.0003</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果：<br><img src="/images/case-study/earth/earth-4.gif" alt="鼠标控制地球旋转" /></p>
<h2 id="📍"><a href="#📍" class="headerlink" title="📍"></a>📍</h2><h3 id="4-加入城市坐标"><a href="#4-加入城市坐标" class="headerlink" title="4. 加入城市坐标"></a>4. 加入城市坐标</h3><p>城市坐标，一个小杆子升起，顶部有个小方块。<br>用来标记城市的位置，传参只需两个，一个是坐标经纬度，一个是城市名称。<br>唯一麻烦的在于将经纬度转到场景中对应的位置。</p>
<p>City.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">'three'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> TWEEN <span class="keyword">from</span> <span class="string">'@tweenjs/tween.js'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CITY_COLOR = <span class="number">0x00DDFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">City</span> </span>&#123;</span><br><span class="line">  private position: THREE.Vector3</span><br><span class="line">  private cityGroup: THREE.Group</span><br><span class="line">  private name: string</span><br><span class="line">  private font: THREE.Font</span><br><span class="line">  private cityName?: THREE.Mesh</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> ([lng, lat]: number[], name: string, font: THREE.Font) &#123;</span><br><span class="line">    <span class="keyword">this</span>.cityGroup = <span class="keyword">new</span> THREE.Group()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> position = <span class="keyword">this</span>.createPosition([lng, lat])</span><br><span class="line">    <span class="keyword">this</span>.position = position</span><br><span class="line">    <span class="keyword">this</span>.name = name</span><br><span class="line">    <span class="keyword">this</span>.font = font</span><br><span class="line">    <span class="keyword">this</span>.createBox(position)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private createBox (position: THREE.Vector3) &#123;</span><br><span class="line">    <span class="keyword">const</span> geometry = <span class="keyword">new</span> THREE.BoxGeometry(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> THREE.MeshBasicMaterial(&#123;</span><br><span class="line">      color: CITY_COLOR,</span><br><span class="line">      side: THREE.DoubleSide,</span><br><span class="line">      opacity: <span class="number">0.5</span>,</span><br><span class="line">      transparent: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> box = <span class="keyword">new</span> THREE.Mesh(geometry, material)</span><br><span class="line">    box.position.copy(position)</span><br><span class="line">    box.lookAt(<span class="keyword">new</span> THREE.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">this</span>.cityGroup.add(box)</span><br><span class="line">    <span class="comment">// 顶部</span></span><br><span class="line">    <span class="keyword">const</span> geometryTop = <span class="keyword">new</span> THREE.BoxGeometry(<span class="number">0.6</span>, <span class="number">0.6</span>, <span class="number">0.6</span>)</span><br><span class="line">    <span class="keyword">const</span> materialTop = <span class="keyword">new</span> THREE.MeshBasicMaterial(&#123;</span><br><span class="line">      color: <span class="number">0xffffff</span>,</span><br><span class="line">      side: THREE.DoubleSide,</span><br><span class="line">      opacity: <span class="number">0.5</span>,</span><br><span class="line">      transparent: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> boxTop = <span class="keyword">new</span> THREE.Mesh(geometryTop, materialTop)</span><br><span class="line">    boxTop.lookAt(<span class="keyword">new</span> THREE.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 底部升起</span></span><br><span class="line">    <span class="keyword">const</span> boxDepth = &#123; <span class="attr">value</span>: <span class="number">0.95</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> tweenRise = <span class="keyword">new</span> TWEEN.Tween(boxDepth).to(&#123; <span class="attr">value</span>: <span class="number">1</span> &#125;, <span class="number">3000</span>)</span><br><span class="line">    tweenRise.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      box.position.set(position.x * boxDepth.value, position.y * boxDepth.value, position.z * boxDepth.value)</span><br><span class="line">    &#125;)</span><br><span class="line">    tweenRise.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 顶部上下浮动</span></span><br><span class="line">    <span class="keyword">const</span> scale = &#123; <span class="attr">value</span>: <span class="number">1.06</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> tween = <span class="keyword">new</span> TWEEN.Tween(scale).to(&#123; <span class="attr">value</span>: <span class="number">1.07</span> &#125;, <span class="number">2000</span>)</span><br><span class="line">    <span class="keyword">const</span> tweenBack = <span class="keyword">new</span> TWEEN.Tween(scale).to(&#123; <span class="attr">value</span>: <span class="number">1.06</span> &#125;, <span class="number">2000</span>)</span><br><span class="line">    tween.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      boxTop.position.set(position.x * scale.value, position.y * scale.value, position.z * scale.value)</span><br><span class="line">    &#125;)</span><br><span class="line">    tweenBack.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      boxTop.position.set(position.x * scale.value, position.y * scale.value, position.z * scale.value)</span><br><span class="line">    &#125;)</span><br><span class="line">    tween.chain(tweenBack)</span><br><span class="line">    tweenBack.chain(tween)</span><br><span class="line">    tween.delay(<span class="number">3000</span>).start()</span><br><span class="line">    <span class="keyword">this</span>.cityGroup.add(boxTop)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 城市名字</span></span><br><span class="line">    <span class="keyword">this</span>.createCityName(<span class="keyword">this</span>.name, position)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private <span class="keyword">async</span> createCityName (name: string, <span class="attr">position</span>: THREE.Vector3) &#123;</span><br><span class="line">    <span class="keyword">const</span> cityNameGeometry = <span class="keyword">new</span> THREE.TextGeometry(name, &#123;</span><br><span class="line">      font: <span class="keyword">this</span>.font,</span><br><span class="line">      size: <span class="number">3</span>,</span><br><span class="line">      height: <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    cityNameGeometry.computeBoundingBox ()</span><br><span class="line">    <span class="keyword">const</span> cityNameMesh = <span class="keyword">new</span> THREE.MeshLambertMaterial(&#123;</span><br><span class="line">      color: <span class="number">0xffffff</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> cityName = <span class="keyword">new</span> THREE.Mesh(cityNameGeometry, cityNameMesh)</span><br><span class="line">    cityName.position.set(position.x - <span class="number">5</span>, position.y - <span class="number">5</span>, position.z - <span class="number">5</span>)</span><br><span class="line">    <span class="comment">// 出现</span></span><br><span class="line">    <span class="keyword">const</span> opacity = &#123; <span class="attr">value</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> tween = <span class="keyword">new</span> TWEEN.Tween(opacity).to(&#123; <span class="attr">value</span>: <span class="number">1.2</span> &#125;, <span class="number">1000</span>)</span><br><span class="line">    tween.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      cityName.position.set(position.x * opacity.value, position.y * opacity.value, position.z * opacity.value)</span><br><span class="line">    &#125;)</span><br><span class="line">    tween.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.cityGroup.add(cityName)</span><br><span class="line">    <span class="keyword">this</span>.cityName = cityName</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private createPosition (lnglat: number[]) &#123;</span><br><span class="line">    <span class="keyword">const</span> spherical = <span class="keyword">new</span> THREE.Spherical()</span><br><span class="line">    spherical.radius = <span class="number">100</span></span><br><span class="line">    <span class="keyword">const</span> lng = lnglat[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">const</span> lat = lnglat[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">const</span> theta = (lng + <span class="number">90</span>) * (<span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">    <span class="keyword">const</span> phi = (<span class="number">90</span> - lat) * (<span class="built_in">Math</span>.PI / <span class="number">180</span>)</span><br><span class="line">    spherical.phi = phi</span><br><span class="line">    spherical.theta = theta</span><br><span class="line">    <span class="keyword">const</span> position = <span class="keyword">new</span> THREE.Vector3()</span><br><span class="line">    position.setFromSpherical(spherical)</span><br><span class="line">    <span class="keyword">return</span> position</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getMesh () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.cityGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPosition () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.position</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  updateCityNameDirection (position: THREE.Vector3) &#123;</span><br><span class="line">    <span class="keyword">this</span>.cityName?.lookAt(position)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  destroy () &#123;</span><br><span class="line">    <span class="keyword">this</span>.cityGroup.clear()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/images/case-study/earth/earth-6.png" alt="城市坐标" style="width:200px;margin:auto;" />

<h2 id="💫"><a href="#💫" class="headerlink" title="💫"></a>💫</h2><h3 id="5-创建从一个坐标到另一个左边连接的贝塞尔曲线"><a href="#5-创建从一个坐标到另一个左边连接的贝塞尔曲线" class="headerlink" title="5. 创建从一个坐标到另一个左边连接的贝塞尔曲线"></a>5. 创建从一个坐标到另一个左边连接的贝塞尔曲线</h3><p>传参即为两个城市（坐标），然后实现动画从坐标1到坐标2。<br>麻烦的点就是调试曲线弧度，好在Three.js有很多现有接口。<br>由于实际请求非常多，</p>
<p>Link.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">'three'</span></span><br><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="keyword">import</span> &#123; MeshLine, MeshLineMaterial &#125; <span class="keyword">from</span> <span class="string">'../lib/meshLine'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> TWEEN <span class="keyword">from</span> <span class="string">'@tweenjs/tween.js'</span></span><br><span class="line"><span class="keyword">import</span> City <span class="keyword">from</span> <span class="string">'./City'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LINK_COLOR = <span class="number">0x00DDFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Link</span> </span>&#123;</span><br><span class="line">  private city1: City</span><br><span class="line">  private city2: City</span><br><span class="line">  private linkGroup: THREE.Group</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> (city1: City, city2: City) &#123;</span><br><span class="line">    <span class="keyword">this</span>.city1 = city1</span><br><span class="line">    <span class="keyword">this</span>.city2 = city2</span><br><span class="line">    <span class="keyword">this</span>.linkGroup = <span class="keyword">new</span> THREE.Group()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.drawLine()</span><br><span class="line">    <span class="keyword">this</span>.drawRing()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  drawLine = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> v0 = <span class="keyword">this</span>.city1.getPosition()</span><br><span class="line">    <span class="keyword">const</span> v3 = <span class="keyword">this</span>.city2.getPosition()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> curve</span><br><span class="line">    <span class="keyword">const</span> angle = v0.angleTo(v3)</span><br><span class="line">    <span class="keyword">if</span> (angle &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; v1, v2 &#125; = getBezierPoint(v0, v3)</span><br><span class="line">      curve = <span class="keyword">new</span> THREE.CubicBezierCurve3(v0, v1, v2, v3) <span class="comment">// 三维三次贝赛尔曲线</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> p0 = <span class="keyword">new</span> THREE.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 法线向量</span></span><br><span class="line">      <span class="keyword">const</span> rayLine = <span class="keyword">new</span> THREE.Ray(p0, getVCenter(v0.clone(), v3.clone())) <span class="comment">// 顶点坐标</span></span><br><span class="line">      <span class="keyword">const</span> vtop = rayLine.at(<span class="number">1.3</span>, <span class="keyword">new</span> THREE.Vector3()) <span class="comment">// 位置</span></span><br><span class="line">      curve = <span class="keyword">new</span> THREE.QuadraticBezierCurve3(v0, vtop, v3) <span class="comment">// 三维二次贝赛尔曲线</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> curvePoints = curve.getPoints(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">const</span> material = <span class="keyword">new</span> MeshLineMaterial(&#123;</span><br><span class="line">      color: LINK_COLOR,</span><br><span class="line">      opacity: <span class="number">0.7</span>,</span><br><span class="line">      transparent: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> lineLength = &#123; <span class="attr">value</span>: <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> line = <span class="keyword">new</span> MeshLine()</span><br><span class="line">    <span class="keyword">const</span> drawLineTween = <span class="keyword">new</span> TWEEN.Tween(lineLength).to(&#123; <span class="attr">value</span>: <span class="number">100</span> &#125;, <span class="number">3000</span>)</span><br><span class="line">    drawLineTween.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      line.setPoints(curvePoints.slice(<span class="number">0</span>, lineLength.value + <span class="number">1</span>), (p: number) =&gt; <span class="number">0.2</span> + p / <span class="number">2</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> eraseLineTween = <span class="keyword">new</span> TWEEN.Tween(lineLength).to(&#123; <span class="attr">value</span>: <span class="number">0</span> &#125;, <span class="number">3000</span>)</span><br><span class="line">    eraseLineTween.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      line.setPoints(curvePoints.slice(curvePoints.length - lineLength.value, curvePoints.length), (p: number) =&gt; <span class="number">0.2</span> + p / <span class="number">2</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    drawLineTween.start()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> eraseLineTween.start(), <span class="number">6000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mesh = <span class="keyword">new</span> THREE.Mesh(line, material)</span><br><span class="line">    <span class="keyword">this</span>.linkGroup.add(mesh)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  drawRing () &#123;</span><br><span class="line">    <span class="comment">// 扩</span></span><br><span class="line">    <span class="keyword">const</span> outter = <span class="keyword">new</span> THREE.RingGeometry(<span class="number">1</span>, <span class="number">1.3</span>, <span class="number">15</span>)</span><br><span class="line">    <span class="keyword">const</span> materialOutter = <span class="keyword">new</span> THREE.MeshBasicMaterial(&#123;</span><br><span class="line">      color: LINK_COLOR,</span><br><span class="line">      side: THREE.DoubleSide,</span><br><span class="line">      opacity: <span class="number">0</span>,</span><br><span class="line">      transparent: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> ringOutter = <span class="keyword">new</span> THREE.Mesh(outter, materialOutter)</span><br><span class="line">    ringOutter.position.copy(<span class="keyword">this</span>.city2.getPosition())</span><br><span class="line">    ringOutter.lookAt(<span class="keyword">new</span> THREE.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">const</span> ringScale = &#123; <span class="attr">value</span>: <span class="number">1</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> drawRingTween = <span class="keyword">new</span> TWEEN.Tween(ringScale).to(&#123; <span class="attr">value</span>: <span class="number">1.1</span> &#125;, <span class="number">200</span>)</span><br><span class="line">    drawRingTween.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      materialOutter.opacity = <span class="number">0.5</span></span><br><span class="line">      ringOutter.scale.set(ringScale.value, ringScale.value, ringScale.value)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> drawRingTweenBack = <span class="keyword">new</span> TWEEN.Tween(ringScale).to(&#123; <span class="attr">value</span>: <span class="number">1</span> &#125;, <span class="number">1000</span>)</span><br><span class="line">    drawRingTweenBack.onUpdate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      materialOutter.opacity = ringScale.value - <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">    drawRingTween.easing(TWEEN.Easing.Circular.Out).delay(<span class="number">3000</span>).chain(drawRingTweenBack.easing(TWEEN.Easing.Circular.In)).start()</span><br><span class="line">    <span class="keyword">this</span>.linkGroup.add(ringOutter)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getMesh () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.linkGroup</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  destroy () &#123;</span><br><span class="line">    <span class="keyword">this</span>.linkGroup.clear()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBezierPoint</span> (<span class="params">v0: THREE.Vector3, v3: THREE.Vector3</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> angle = (v0.angleTo(v3) * <span class="number">180</span>) / <span class="built_in">Math</span>.PI <span class="comment">// 0 ~ Math.PI       // 计算向量夹角</span></span><br><span class="line">  <span class="keyword">const</span> aLen = angle</span><br><span class="line">  <span class="keyword">const</span> p0 = <span class="keyword">new</span> THREE.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 法线向量</span></span><br><span class="line">  <span class="keyword">const</span> rayLine = <span class="keyword">new</span> THREE.Ray(p0, getVCenter(v0.clone(), v3.clone())) <span class="comment">// 顶点坐标</span></span><br><span class="line">  <span class="keyword">const</span> vtop = <span class="keyword">new</span> THREE.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// 法线向量</span></span><br><span class="line">  rayLine.at(<span class="number">100</span>, vtop) <span class="comment">// 位置</span></span><br><span class="line">  <span class="comment">// 控制点坐标</span></span><br><span class="line">  <span class="keyword">const</span> v1 = getLenVcetor(v0.clone(), vtop, aLen)</span><br><span class="line">  <span class="keyword">const</span> v2 = getLenVcetor(v3.clone(), vtop, aLen)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    v1: v1,</span><br><span class="line">    v2: v2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getVCenter</span> (<span class="params">v1: THREE.Vector3, v2: THREE.Vector3</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> v = v1.add(v2)</span><br><span class="line">  <span class="keyword">return</span> v.divideScalar(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLenVcetor</span> (<span class="params">v1: THREE.Vector3, v2: THREE.Vector3, len: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> v1v2Len = v1.distanceTo(v2)</span><br><span class="line">  <span class="keyword">return</span> v1.lerp(v2, len / v1v2Len)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/images/case-study/earth/earth-7.png" alt="连线" style="width:200px;margin:auto;" />


<h2 id="加一点光晕-🪐"><a href="#加一点光晕-🪐" class="headerlink" title="加一点光晕 🪐"></a>加一点光晕 🪐</h2><p>Earth.ts 中添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 地球光晕</span></span><br><span class="line"><span class="keyword">const</span> geometry = <span class="keyword">new</span> THREE.CircleGeometry(radius + <span class="number">1.5</span>, radius)</span><br><span class="line"><span class="keyword">const</span> material = <span class="keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="attr">color</span>: <span class="number">0xd7fcf6</span>, <span class="attr">side</span>: THREE.DoubleSide &#125;)</span><br><span class="line"><span class="keyword">const</span> material2 = <span class="keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="attr">color</span>: <span class="number">0xd1bdff</span>, <span class="attr">side</span>: THREE.DoubleSide &#125;)</span><br><span class="line"><span class="keyword">const</span> circle = <span class="keyword">new</span> THREE.Mesh(geometry, material)</span><br><span class="line"><span class="keyword">const</span> circle2 = <span class="keyword">new</span> THREE.Mesh(geometry, material2)</span><br><span class="line"><span class="keyword">const</span> glowGrop = <span class="keyword">new</span> THREE.Group()</span><br><span class="line">circle.layers.set(<span class="number">1</span>)</span><br><span class="line">circle2.layers.set(<span class="number">1</span>)</span><br><span class="line">glowGrop.add(circle)</span><br><span class="line">glowGrop.add(circle2)</span><br><span class="line"><span class="keyword">this</span>.earthGlow = glowGrop</span><br></pre></td></tr></table></figure>

<img src="/images/case-study/earth/earth-8.png" alt="地球光晕" style="width:400px;margin:auto;" />


<h2 id="End"><a href="#End" class="headerlink" title="End."></a>End.</h2><p>到这基本上就完成了，由于反爬监控请求量巨大，全都显示风扇会起飞，所以要节流一下，最后其实也只显示了很少一部分，看个热闹。</p>
</div><div class="tags"><a href="/tags/JavaScript/"><i class="fa fa-tag"></i>JavaScript</a><a href="/tags/Tools/"><i class="fa fa-tag"></i>Tools</a></div><div class="post-nav"><a class="pre" href="/case-study/spider-challenge/">爬虫攻防战 🕷</a><a class="next" href="/fe/JavaScript/13.first-time-vite/">Vite 踩坑</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://ykzhukian.github.io/case-study/earth-globe/';
    this.page.identifier = 'case-study/earth-globe/';
    this.page.title = '模仿 GitHub 首页的地球 🌍';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//ykzhukian-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//ykzhukian-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://ykzhukian-github-io.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Case-Study/">Case Study</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/">Development</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Noncence/">Noncence</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Photograph/">Photograph</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Reading-Notes/">Reading Notes</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/Read/" style="font-size: 15px;">Read</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/Design/" style="font-size: 15px;">Design</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/noncence/20220202-daily/">PR 过期了</a></li><li class="post-list-item"><a class="post-list-link" href="/fe/JavaScript/14.mouse-track/">前端反爬：鼠标轨迹</a></li><li class="post-list-item"><a class="post-list-link" href="/noncence/20220127-daily/">听了老板建硕的一个分享</a></li><li class="post-list-item"><a class="post-list-link" href="/webpack/3.webpack-base/">一些 Webpack 相关备忘</a></li><li class="post-list-item"><a class="post-list-link" href="/photo/2.2022-qingdao/">青岛跨年</a></li><li class="post-list-item"><a class="post-list-link" href="/fe/Engineering/1.private-npm-nexus/">私有 npm 仓库 Nexus & 工具库配合 GitLab 自动发布</a></li><li class="post-list-item"><a class="post-list-link" href="/reading/7.meituan-micro-fe/">稀土大会记录</a></li><li class="post-list-item"><a class="post-list-link" href="/case-study/shield/">百姓网反爬虫系统：神盾管理后台</a></li><li class="post-list-item"><a class="post-list-link" href="/case-study/micro-front-end/">微前端在基础架构应用系列的实践</a></li><li class="post-list-item"><a class="post-list-link" href="/case-study/spider-challenge/">爬虫攻防战 🕷</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 其他链接</i></div><ul></ul><a href="https://github.com/ykzhukian/notebook" title="代码相关的笔记" target="_blank">代码相关的笔记</a><ul></ul><a href="https://github.com/ykzhukian" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://www.instagram.com/kianykz/" title="Instagram" target="_blank">Instagram</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© 2022 <a href="/." rel="nofollow">Kian Zhu</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>